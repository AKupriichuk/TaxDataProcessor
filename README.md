# üõ† Technical Documentation: Tax Data Processor

## üèó –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–Ω–∏–π –¥–∏–∑–∞–π–Ω (ETL Pipeline)

–°–∏—Å—Ç–µ–º–∞ —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞ —è–∫ –º–æ–¥—É–ª—å–Ω–∏–π ETL-–ø–∞–π–ø–ª–∞–π–Ω (Extract, Transform, Load), —â–æ –∑–∞–±–µ–∑–ø–µ—á—É—î —á—ñ—Ç–∫–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª –æ–±–æ–≤'—è–∑–∫—ñ–≤ (Separation of Concerns):

* **Ingestion Layer (`main.py` & `loaders.py`)**: –†–µ–∞–ª—ñ–∑—É—î –º–µ—Ö–∞–Ω—ñ–∑–º **Discovery**. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `pathlib`, —Å–∏—Å—Ç–µ–º–∞ –¥–∏–Ω–∞–º—ñ—á–Ω–æ –±—É–¥—É—î –¥–µ—Ä–µ–≤–æ –≤—Ö—ñ–¥–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤, —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î `Source` –∑–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —à–ª—è—Ö—É —Ç–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î —Å–µ—Å—ñ—é –æ–±—Ä–æ–±–∫–∏.
* **Transformation Layer (`processors/`)**: –°–ø–µ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∞–¥–∞–ø—Ç–µ—Ä–∏ (`stripe_processor`, `paypal_processor`) –≤–∏–∫–æ–Ω—É—é—Ç—å –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—é —Å–∏—Ä–∏—Ö –¥–∞–Ω–∏—Ö –¥–æ —î–¥–∏–Ω–æ–≥–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—å–æ–≥–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É. –¢—É—Ç —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—É –ª–æ–≥—ñ–∫—É T-–∫–æ–¥—ñ–≤ PayPal —Ç–∞ –º–∞–ø—ñ–Ω–≥ —é—Ä–∏–¥–∏—á–Ω–∏—Ö –æ—Å—ñ–±.
* **Enrichment & Calculation Engine (`utils.py`)**: –°–µ—Ä—Ü–µ —Å–∏—Å—Ç–µ–º–∏, –¥–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–±–∞–≥–∞—á–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö (Tax & Project mapping) —Ç–∞ —Ñ—ñ–Ω–∞–Ω—Å–æ–≤—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏.
* **Storage Layer**: –ó–∞–±–µ–∑–ø–µ—á—É—î —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —á–µ—Ä–µ–∑ —ñ—î—Ä–∞—Ä—Ö—ñ—á–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É `year/quarter/month`, –∑–∞–ø–æ–±—ñ–≥–∞—é—á–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É —Ñ–∞–π–ª—ñ–≤ —á–µ—Ä–µ–∑ UID-—Ç—Ä–µ–∫—ñ–Ω–≥.

## ‚ö° –¢–µ—Ö–Ω—ñ—á–Ω—ñ —Ä—ñ—à–µ–Ω–Ω—è —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

### 1. –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –æ–±—Ä–æ–±–∫–∏ –¥–∞–Ω–∏—Ö

* **Vectorization over Iteration**: –ó–∞–º—ñ—Å—Ç—å —Ü–∏–∫–ª—ñ–≤ `for` (iterrows), —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –ü–î–í —Ç–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è –≤ USD —Ä–µ–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ —á–µ—Ä–µ–∑ **–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é Pandas**. –¶–µ –¥–æ–∑–≤–æ–ª—è—î –æ–±—Ä–æ–±–ª—è—Ç–∏ —Ç–∏—Å—è—á—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π –∑–∞ –º—ñ–ª—ñ—Å–µ–∫—É–Ω–¥–∏.
* **Constant-Time Rate Access**: –ö—É—Ä—Å–∏ –≤–∞–ª—é—Ç —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º—É—é—Ç—å—Å—è —É **MultiIndex Series** –∞–±–æ —Ö–µ—à-—Ç–∞–±–ª–∏—Ü—é (`dict`). –¶–µ –∑–∞–±–µ–∑–ø–µ—á—É—î —Å–∫–ª–∞–¥–Ω—ñ—Å—Ç—å –ø–æ—à—É–∫—É –∫—É—Ä—Å—É , —â–æ —î –∫—Ä–∏—Ç–∏—á–Ω–∏–º –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –≤–µ–ª–∏–∫–∏—Ö CSV-–¥–∞–º–ø—ñ–≤ –≤—ñ–¥ Stripe.

### 2. –°—Ç—ñ–π–∫—ñ—Å—Ç—å —Ç–∞ —Ü—ñ–ª—ñ—Å–Ω—ñ—Å—Ç—å (Data Integrity)

* **Conflict Resolution**: –†–µ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –º–µ—Ö–∞–Ω—ñ–∑–º –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —ñ–º–µ–Ω –≤–∏—Ö—ñ–¥–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö (`source + entity + month`). –¶–µ —É—Å—É–≤–∞—î —Ä–∏–∑–∏–∫ –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö –ø—Ä–∏ –∑–ª–∏—Ç—Ç—ñ –∫—ñ–ª—å–∫–æ—Ö –ø–æ—Ç–æ–∫—ñ–≤ PayPal.
* **Format Agnosticism**: –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É –ü–î–í –ø—ñ–¥—Ç—Ä–∏–º—É—î —Ä—ñ–∑–Ω—ñ —Ñ–æ—Ä–º–∞—Ç–∏ –≤—Ö—ñ–¥–Ω–∏—Ö —Å—Ç–∞–≤–æ–∫ (–¥–µ—Å—è—Ç–∫–æ–≤–∏–π `0.21` —Ç–∞ –≤—ñ–¥—Å–æ—Ç–∫–æ–≤–∏–π `21.0`), –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–æ—Ä–º–∞–ª—ñ–∑—É—é—á–∏ —ó—Ö –ø–µ—Ä–µ–¥ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è–º.
* **Strict Sign Logic**: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —ñ–Ω–≤–µ—Ä—Ç—É—î –∑–Ω–∞–∫–∏ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π —Ç–∏–ø—É `Refund` —Ç–∞ `Chargeback`, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω—É —Ç–æ—á–Ω—ñ—Å—Ç—å —Ñ—ñ–Ω–∞–ª—å–Ω–∏—Ö –ø–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∑–æ–±–æ–≤'—è–∑–∞–Ω—å.

## üß™ –ì–∞—Ä–∞–Ω—Ç—ñ—è —è–∫–æ—Å—Ç—ñ —Ç–∞ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è (QA)

–ü—Ä–æ—î–∫—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤–∞–ª—ñ–¥–∞—Ü—ñ—é —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–∏–π –Ω–∞–±—ñ—Ä —Ç–µ—Å—Ç—ñ–≤ `pytest`, —â–æ –≤–∫–ª—é—á–∞—î:

* **Financial Reconciliation**: –°–∫—Ä—ñ–∑–Ω–∞ –∑–≤—ñ—Ä–∫–∞ (End-to-End). –°–∫—Ä–∏–ø—Ç –ø–æ—Ä—ñ–≤–Ω—é—î —Å—É–º—É `Amount` —É—Å—ñ—Ö –≤—Ö—ñ–¥–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ —ñ–∑ —Å—É–º–æ—é —É —Ñ—ñ–Ω–∞–ª—å–Ω–æ–º—É –∑–≤—ñ—Ç—ñ. –î–æ–ø—É—Å–∫ –ø–æ–º–∏–ª–∫–∏ ‚Äî –Ω—É–ª—å–æ–≤–∏–π (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è –¥–æ 2 –∑–Ω–∞–∫—ñ–≤).
* **Tax Engine Testing**: –í–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞—Ä–∞—Ö—É–≤–∞–Ω–Ω—è –ü–î–í –¥–ª—è –∫—Ä–∞—ó–Ω –Ñ–° —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ "–Ω—É–ª—å–æ–≤–æ—ó —Å—Ç–∞–≤–∫–∏" –¥–ª—è Non-EU —Ä–µ–≥—ñ–æ–Ω—ñ–≤.
* **Mapping Coverage**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –≤—Å—ñ—Ö —Å—É—Ç–Ω–æ—Å—Ç–µ–π (LE, Projects) —É –¥–æ–≤—ñ–¥–Ω–∏–∫–∞—Ö.

### üß™ Quality Assurance (QA)

–ü—Ä–æ–µ–∫—Ç –ø–æ–∫—Ä–∏—Ç–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–æ–≤–∞–Ω–∏–º–∏ —Ç–µ—Å—Ç–∞–º–∏ –Ω–∞ –±–∞–∑—ñ `pytest`:

1. **Reconciliation Test**: –ü–æ–≤–Ω–∞ –∑–≤—ñ—Ä–∫–∞ —Å—É–º `in_total` vs `out_total` –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —ñ–Ω–≤–µ—Ä—Å—ñ—ó –∑–Ω–∞–∫—ñ–≤ –¥–ª—è Refunds/Chargebacks. –î–æ–ø—É—Å—Ç–∏–º–∞ –¥–µ–ª—å—Ç–∞ < 1.0 (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤—Ç—Ä–∞—Ç–∏ –¥–∞–Ω–∏—Ö).
2. **Tax Logic Validation**: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–∏—Ö —Å—Ç–∞–≤–æ–∫ –ü–î–í –∑–∞–∫–æ–Ω–æ–¥–∞–≤—á–∏–º –Ω–æ—Ä–º–∞–º –≤–∫–∞–∑–∞–Ω–∏—Ö –∫—Ä–∞—ó–Ω –Ñ–°.
3. **Mapping Coverage**: –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–æ–≤–Ω–æ—Ç–∏ –∑–±–∞–≥–∞—á–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö (Project & Legal Entity mapping).
   <img width="884" height="479" alt="image" src="https://github.com/user-attachments/assets/f0920ccc-c348-4154-8a7f-39d5fec8640f" />


### üì¶ Installation & Setup

1. Clone the repository.
2. Install dependencies: `pip install requirements.txt`.
3. Run main script: `python main.py`.

